<!DOCTYPE HTML>
<html>
	<head>
		<title>CODOX ortesis inteligente</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="icon" href="images/logo.png" type="image/png" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">
		<!-- Wrapper -->
			<div id="wrapper">
				<!-- Header -->
					<header id="header">
						<div class="logo">
							<div class="logo">
								<img src="images/logo.png" style="width:80px; height:auto;" alt="CODOX Logo">
							</div>
						</div>
						<div class="content">
							<div class="inner">
								<h1>CODOX</h1>
								<p>Proyectos de Biodise침o</p>
							</div>
						</div>
						<nav>
							<ul>
								<li><a href="#intro">Nueva terapia</a></li>
								<li><a href="#work">Continuar </a></li>
								<li><a href="#about">Seguimiento</a></li>
								<li><a href="#ajustes">Ajustes</a></li>
								<!--<li><a href="#elements">Elements</a></li>-->
							</ul>
						</nav>
					</header>
				<!-- Main -->
					<div id="main">
						<article id="intro">
						<!-- ================= NUEVA TERAPIA ================= -->
						<section id="nueva-terapia" class="panel">
   							<h2>Nueva Terapia</h2>

    						<form id="formPaciente">
        						<label>Nombre del paciente:</label>
        						<input type="text" id="nombrePaciente" required>

        						<label>Edad:</label>
        						<input type="number" id="edadPaciente">

        						<label>Observaciones:</label>
       	 						<textarea id="obsPaciente"></textarea>

        						<button type="submit">Guardar Paciente</button>
    						</form>

    						<p id="msgGuardado" style="display:none; color:green;">
        						Paciente guardado correctamente.
    						</p>
						</section>
						</article>
									<!-- ================= LISTA DE PACIENTES ================= -->
						<article id="work">
						<section id="lista-pacientes" class="panel">
   			 				<h2>Pacientes Registrados</h2>
    						<ul id="contenedorPacientes"></ul>
						</section>
						</article>
			<!-- ================= DETALLE DE PACIENTE ================= -->
						<article id="detalle-paciente" class="panel">
    						<h2 id="tituloPaciente"></h2>
    						<canvas id="grafica" width="400" height="200"></canvas>

    						<p><strong>츼ngulo m치ximo:</strong> <span id="maxAngulo">0</span></p>
    						<p><strong>Fuerza m치xima:</strong> <span id="maxFuerza">0</span></p>

    						<button id="btnGuardarSesion">Guardar sesi칩n</button>
						</article>
						<!-- About -->
							<article id="about">
								<h2 class="major">Seguimiento</h2>
    							<ul id="listaSesiones"></ul>
							</article>
						<!-- Contact -->
							<article id="ajustes">
  								<h2>Ajustes</h2>
  								<p><strong>Estado de conexi칩n:</strong> 
     								<span id="estadoConexion">游댮 No conectado</span>
  								</p>
  								<button id="btnConectar">Verificar conexi칩n</button>
							</article>
					</div>
				<!-- Footer -->
					<footer id="footer">
						<p class="copyright">&copy; Untitled. Design: <a href="https://html5up.net">HTML5 UP</a>.</p>
					</footer>
			</div>
		<!-- BG -->
			<div id="bg"></div>
		<!-- Scripts -->
			<!-- ================= FIREBASE ================= -->
			<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
			<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

			<script>
			const firebaseConfig = {
  				apiKey: "TU_API_KEY",
  				authDomain: "TU_AUTH_DOMAIN",
  				databaseURL: "TU_DATABASE_URL",
  				projectId: "TU_PROJECT_ID",
  				storageBucket: "TU_BUCKET",
  				messagingSenderId: "TU_SENDER",
  				appId: "TU_APP"
			};

			firebase.initializeApp(firebaseConfig);
			const db = firebase.database();
			</script>
			<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
			<script>
/* ========== GUARDAR PACIENTE ========== */
			document.getElementById("formPaciente").addEventListener("submit", function(e) {
    			e.preventDefault();
    			const nombre = document.getElementById("nombrePaciente").value;
    			const edad = document.getElementById("edadPaciente").value;
    			const obs = document.getElementById("obsPaciente").value;
    // cargar lista
    			let pacientes = JSON.parse(localStorage.getItem("pacientes")) || [];
    // agregar nuevo
    			pacientes.push({
        			nombre: nombre,
        			edad: edad,
        			obs: obs
    			});
    // guardar
    			localStorage.setItem("pacientes", JSON.stringify(pacientes));
				db.ref("pacientes").push({
    				nombre,
    				edad,
    				obs
				});

    // mensaje
    			document.getElementById("msgGuardado").style.display = "block";
    			this.reset();
			});
/* ========== MOSTRAR LISTA DE PACIENTES ========== */
			function cargarPacientes() {
    			let contenedor = document.getElementById("contenedorPacientes");
    			contenedor.innerHTML = "";

    			let pacientes = JSON.parse(localStorage.getItem("pacientes")) || [];

    			pacientes.forEach((p, index) => {
        			let li = document.createElement("li");
        			li.textContent = p.nombre;
        			li.style.cursor = "pointer";
        			li.onclick = () => mostrarDetalle(index);
        			contenedor.appendChild(li);
    			});
			}

/* ========== MOSTRAR DETALLE ========== */
			function mostrarDetalle(index) {
    			let pacientes = JSON.parse(localStorage.getItem("pacientes")) || [];
    			let p = pacientes[index];

    			document.getElementById("tituloPaciente").textContent = p.nombre;

    			datosAngulo = [];
    			datosFuerza = [];
    			maxAngulo = 0;
    			maxFuerza = 0;

    			setTimeout(crearGrafica, 300);

    			location.hash = "#detalle-paciente";
    			localStorage.setItem("pacienteActual", index);
			}

/* ========== CAMBIO ENTRE SECCIONES ========== */
/* Cargar pacientes cuando entres a lista */
			document.querySelector("a[href='#work']").addEventListener("click", cargarPacientes);
			</script>
			<script>
			let chart = null;

			function crearGrafica() {
    			const ctx = document.getElementById("grafica").getContext("2d");
				if (chart) {
        			chart.destroy();
    			}

    			chart = new Chart(ctx, {
        			type: "line",
        			data: {
            			labels: [],
            			datasets: [
                			{
                    			label: "츼ngulo (춿)",
                    			data: datosAngulo,
                    			borderWidth: 2
                			},
                			{
                    			label: "Fuerza (N)",
                    			data: datosFuerza,
                    			borderWidth: 2
                			}
            			]
        			},
        			options: {
            			responsive: true,
            			animation: false
        			}
   	 			});
			}
			</script>
			<script>
			let socket = null;
			let intentoReconnect = null;

			function conectarESP32() {
    			if (socket && socket.readyState === WebSocket.OPEN) return;

    			socket = new WebSocket("ws://192.168.4.1:81");

    			socket.onopen = function () {
       	 			document.getElementById("estadoConexion").textContent = "游릭 Conectado";
        			document.getElementById("estadoConexion").style.color = "green";

        			if (intentoReconnect) {
            			clearInterval(intentoReconnect);
	            		intentoReconnect = null;
        			}
    			};

    			socket.onerror = function () {
        			document.getElementById("estadoConexion").textContent = "游댮 Error";
        			document.getElementById("estadoConexion").style.color = "red";
    			};

    			socket.onclose = function () {
        			document.getElementById("estadoConexion").textContent = "游댮 Desconectado";
        			document.getElementById("estadoConexion").style.color = "red";

        // Intento autom치tico cada 3 segundos
        			if (!intentoReconnect) {
            			intentoReconnect = setInterval(conectarESP32, 3000);
        			}
    			};

    			socket.onmessage = function (event) {

        			let data = JSON.parse(event.data);

        			datosAngulo.push(data.angulo);
        			datosFuerza.push(data.fuerza);

        			if (data.angulo > maxAngulo) maxAngulo = data.angulo;
        			if (data.fuerza > maxFuerza) maxFuerza = data.fuerza;

        			document.getElementById("maxAngulo").textContent = maxAngulo;
        			document.getElementById("maxFuerza").textContent = maxFuerza;
        			if (chart) {
            			chart.data.labels.push(chart.data.labels.length);
            			chart.update();
        			}
    			};
			}
			document.getElementById("btnConectar").addEventListener("click", conectarESP32);
			</script>
			<script>
			document.getElementById("btnGuardarSesion").addEventListener("click", function () {
    
    			let id = localStorage.getItem("pacienteActual");
    			let pacientes = JSON.parse(localStorage.getItem("pacientes")) || [];

    			if (!pacientes[id].sesiones) {
        			pacientes[id].sesiones = [];
    			}
    			pacientes[id].sesiones.push({
        			fecha: new Date().toLocaleString(),
        			datosAngulo: datosAngulo,
        			datosFuerza: datosFuerza,
       		 		maxAngulo: maxAngulo,
        			maxFuerza: maxFuerza
    			});
    			localStorage.setItem("pacientes", JSON.stringify(pacientes));
    			alert("Sesi칩n guardada correctamente.");
			});
			db.ref("sesiones").push({
    			paciente: pacientes[id].nombre,
    			fecha: new Date().toLocaleString(),
    			datosAngulo,
    			datosFuerza,
    			maxAngulo,
    			maxFuerza
			});

			</script>
			<script>
			document.querySelector("a[href='#about']").addEventListener("click", function () {

    			const id = localStorage.getItem("pacienteActual");
				db.ref("pacientes").once("value").then(snapshot => {
    				let pacientes = snapshot.val() || {};
    			// luego generas lista
				});

    // Si no hay pacientes a칰n, salir
    			if (!pacientes[id]) return;

    			let sesiones = pacientes[id].sesiones || [];

    			let cont = document.getElementById("listaSesiones");
    			cont.innerHTML = "";

    			if (sesiones.length === 0) {
        			cont.innerHTML = "<p>No hay sesiones guardadas para este paciente.</p>";
        			return;
    			}
    			sesiones.forEach(s => {
        			let li = document.createElement("li");
        			li.innerHTML = `
            			<strong>${s.fecha}</strong><br>
            			M치x 츼ngulo: ${s.maxAngulo}<br>
            			M치x Fuerza: ${s.maxFuerza}
        			`;
        			cont.appendChild(li);
    			});
			});
			</script>
	</body>
</html>





